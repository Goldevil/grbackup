
* [What is GR Backup ?](#GR-Backup)
* [How to use GR Backup?](#usage)
* [Past and future of GR Backup?](#versions)
* [What libraries are used?](#libraries)
* [Who did this?](#author)
* [License](#license)

# GR Backup

## Purpose
GR Backup is a python 3 script creating local copies of files from a remote server using SFTP download. It is designed to be executed as a scheduled task for regular backups of a remote server.
It started as a very simple script for a one shot operation. This was an oportunity to experiment and learn with the Python language. With time it evolved into a more structured project. 

GR stands for "Get Remote" as I use it for downloading tgz files from a remote linux server. These files are generated by a bash script which performs backup of a set of folders uzing tar and gz. 

## Main features

* Configuration using a YAML file (grbackup.conf)
* Multiple remote servers can be configured in a single configuration file
* downloads only file changed since last execution.
* Detailed log file
* Send report emails via SSH SMTP 

# Usage

## Launching grbackup

The following command line will perform the backup following the configuration named "MyServer" defined in the grbackup.conf file.

```>> python3 grbackup.py MyServer 1>> grbackup.log 2>> grbackup.err```

## Default configuration (all servers)

The configuration file grbackup.conf contains a list of default parameters at the top. These parameters are automatically applied to all server specific configuration but can be overloaded.

Here is a sample default section of the grbackup.conf file

```
# Configure logging and reporting
log:
  # Output on console
  console: true
  # Output on email report (email report parameters are mandatory)
  email: true
  # Output in a log file (parameter log_filename is mandatory)
  file: true
  # Log additional debug information
  debug: false 

files:
  # transfer folder structure or only files in the source folder
  process_subfolders: true

# Configure target host
source:
  # Default port for SFTP
  port: 22

# Configure execution mode
execmode:
  # download not only updated files but also new files (not existing in target folder).
  # If false, only use the date of last execution to get files
  sync: true
  # simulate execution but do not download any file
  simulation: false

# Configure email report
emailreport:
  #  for SSL 587 and for TLS
  ssl_port: 465  
  # name of mail server
  server: smtp.gmail.com
  # credentials to authenticate to SMTP server
  username: john.doe
  password: mailpassword
  # Source and destination email addresses
  source_address: john.doe@gmail.com
  dest_address: john.smith@gmail.com
```

## Server specific configuration

Here is a sample configuration section for a remote server 

```
# Configuration for server named MyServer
name: MyServer
# Define a clear label
label: MyServer backup
# File for storing timestamp of last execution
last_exec_filename: /home/theuser/grbackup/grbackup_myserver_last.txt
# Configure log
log:
  filename: /home/theuser/grbackup/grbackup_myserver.log
# Configure remote host from where the files will be downloaded
source:
  host: myserver.mydomain.com
  # Configure credentials
  password: password
  username: username
  # Configure paths
  #Remote folder from where files will be downloaded
  folder: /opt/backup/source/  
target:
  #Folder where files will be stored. Don't forget the trailing slash !
  folder: /home/theuser/BackupMyServer/      
```

# Versions
## Version history

* **V 0.1.0** - 02/01/2020  
KEF: Base implementation (all hardcoded)
* **V 0.2.0** - 07/01/2020  
KEF: Parametrisation in param file + manage date last backup
* **V 0.3.0** - 12/01/2020  
KEF: Support of debug mode and simulation mode
* **V 0.4.0** - 15/01/2020  
KEF: Avoid overwritting of previous version (Rename previous version of a file and delete it only after successful download)  
KEF: Error handling  
KEF: Display file size in human readable format (KB, MB...)
* **V 0.5.0** - 18/01/2020  
KEF: New sync mode: download not only updated files but also files missing in local folder
* **V 0.6.0** - 25/01/2020  
KEF: Move parameter for file storing last execution date into parameter files. 
* **V 0.7.0** - 08/02/2020  
KEF: create log function  
KEF: send log in email (supports Gmail SMTP with SSL)  
KEF: log into text file  
KEF: parameter to control log mode (console output and/or logfile and/or email report)
* **V 0.7.1** - 09/02/2020  
KEF: BUG syntax error in display message when cannot connect to server  
KEF: BUG missing closing of log file
* **V 0.8.0** - 16/02/2020  
KEF: parameters in text format (YAML instead of python module)  
KEF: Supports multiple configurations in a single conf file (multiple settings for multiple remote servers)  
KEF: Support default parameters (applicable to multiple configuration)  
KEF: Command line argument to select the configuration to execute  
* **V 0.8.1** - 16/02/2020  
KEF: Error handling when loading parameters  
* **V 0.8.2** - 16/02/2020  
KEF: Corrected subject for email report  
* **V 0.8.3** - 29/02/2020  
KEF: Use standard python logging library instead of custom file write. --> Benefits: flush log file during execution (not at end of execution), include libraries logs  
KEF: Rename class param into gr_param. Allows support of python 2.  
* **V 0.9.0** - 07/03/2020  
KEF: Calculate and display duration  
* **V 0.9.1** - 13/03/2020  
KEF: subject of mail report updated  
* **V 0.10.0** - 28/11/2020  
KEF: Better usage of python 3 logging package  
KEF: Bug about temporary backup file solved  

## Planned features

I do not commit to implement any of these features. The current version already fits my needs.

* [MEDIUM] Restructure code to put everything in classes and better align with Python standards
* [MEDIUM] Improve exception handling (in particular in email sending part)
* [MEDIUM] Manage folder structure, allowing to download subfolders. It should be able to avoid links (controlled by parameters)
* [MEDIUM] Keep status last exec for each file, not relies on a single date for a complete sync (SQLite DB?)
* [MEDIUM] Keeping older versions of files with retention policy (nb of versions, max size, dates...)
* [MEDIUM] Support keystore vault of credentials to avoid password displayed in clear in the config files
* [LOW] Calculate and display transfert rate in logs
* [LOW] Display status bar in linux console
* [LOW] Create root target directory if not exists (controlled by parameters)
* [LOW] Support parameter file in /etc folder on Unix based system
* [LOW] extended to support local-to-local, local-to-remote and remote-to-remote, not only remote-to-local. In other convert this script in a more universal synchronisation tool
* [LOW] Support encryption of copies
* [LOW] Support compression of copies

# Libraries

* SFTP implemented using [Paramiko](https://docs.paramiko.org)
* YAMLconfig file loader uses [PyYaml](https://pyyaml.org/)

# Author

GR Backup has been written by Karim El Founas (KEF) karim.elfounas@gmail.com

# License

GR Backup is published under LGPL-2.0 (see LICENSE file)